<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Senkisem - Fizet√©s</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #111111 25%, #1a1a1a 50%, #0f0f0f 100%);
      min-height: 100vh;
      color: #ffffff;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 2rem;
      backdrop-filter: blur(20px);
    }

    .checkout-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .checkout-header h1 {
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
      color: #ffffff;
    }

    .checkout-header p {
      color: rgba(255, 255, 255, 0.6);
      font-size: 1.1rem;
    }

    .checkout-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 3rem;
      align-items: start;
    }

    .form-section {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 500;
      margin-bottom: 1.5rem;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .input-group {
      margin-bottom: 1.5rem;
    }

    .input-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: #ffffff;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #ffffff;
      background: rgba(255, 255, 255, 0.1);
    }

    .input-group input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .flex {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .shipping-options {
      display: grid;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .shipping-option {
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.02);
    }

    .shipping-option:hover {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.05);
    }

    .shipping-option.selected {
      border-color: #ffffff;
      background: rgba(255, 255, 255, 0.08);
    }

    .shipping-option-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .shipping-option-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: #ffffff;
    }

    .shipping-option-price {
      font-weight: 700;
      color: #ffffff;
    }

    .shipping-option-desc {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .pickup-point-selector {
      margin-top: 1rem;
      display: none;
    }

    .pickup-point-selector.active {
      display: block;
    }

    .pickup-search {
      position: relative;
      margin-bottom: 1rem;
    }

    .pickup-search input {
      padding-right: 3rem;
    }

    .pickup-search button {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      border: none;
      padding: 0.5rem;
      border-radius: 6px;
      color: #ffffff;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .pickup-search button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .pickup-points-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
    }

    .pickup-point {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .pickup-point:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .pickup-point.selected {
      background: rgba(255, 255, 255, 0.1);
    }

    .pickup-point:last-child {
      border-bottom: none;
    }

    .pickup-point-name {
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: #ffffff;
    }

    .pickup-point-address {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 0.3rem;
    }

    .pickup-point-info {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .home-delivery-address {
      margin-top: 1rem;
      display: none;
    }

    .home-delivery-address.active {
      display: block;
    }

    .order-summary {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 2rem;
      position: sticky;
      top: 2rem;
    }

    .order-summary h3 {
      font-size: 1.3rem;
      margin-bottom: 1.5rem;
      color: #ffffff;
    }

    .cart-items {
      margin-bottom: 1.5rem;
    }

    .cart-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
    }

    .cart-item-details {
      flex: 1;
    }

    .cart-item-name {
      font-weight: 500;
      margin-bottom: 0.3rem;
      color: #ffffff;
    }

    .cart-item-price {
      color: rgba(255, 255, 255, 0.6);
    }

    .size-selector {
      margin-top: 0.5rem;
    }

    .size-selector select {
      padding: 0.3rem 0.5rem;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: #fff;
    }

    .order-totals {
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding-top: 1rem;
    }

    .order-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .order-line.total {
      font-weight: 700;
      font-size: 1.2rem;
      color: #ffffff;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding-top: 0.5rem;
      margin-top: 1rem;
    }

    .back-links {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.8rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #ffffff;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .submit-btn {
      width: 100%;
      padding: 1.2rem;
      background: linear-gradient(135deg, #ffffff, #f0f0f0);
      color: #000000;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* √ÅSZF + email consent */
    .terms-acceptance {
      margin: 1.5rem 0;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .terms-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      cursor: pointer;
      user-select: none;
      margin-bottom: 0.75rem;
    }

    .terms-checkbox:last-child {
      margin-bottom: 0;
    }

    .terms-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 2px;
      accent-color: #ffffff;
    }

    .terms-text {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .terms-link {
      color: #ffffff;
      text-decoration: underline;
      font-weight: 600;
      transition: opacity 0.3s ease;
    }

    .terms-link:hover {
      opacity: 0.8;
    }

    @media (max-width: 768px) {
      .checkout-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
      }
      .order-summary {
        position: static;
      }
      .flex {
        grid-template-columns: 1fr;
      }
      .back-links {
        flex-direction: column;
      }
      .container {
        padding: 1rem;
      }
      .terms-acceptance {
        margin: 1rem 0;
        padding: 0.75rem;
      }
      .terms-text {
        font-size: 0.9rem;
      }
      .terms-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="checkout-header">
      <h1>Rendel√©s v√©gleges√≠t√©se</h1>
      <p>V√°laszd ki a sz√°ll√≠t√°si m√≥dot √©s add meg az adataidat</p>
    </div>

    <div class="back-links">
      <a href="index.html" class="back-btn">‚Üê Vissza a f≈ëoldalra</a>
      <a href="index.html#clothing" class="back-btn">üõí Kos√°r m√≥dos√≠t√°sa</a>
    </div>

    <form id="checkout-form">
      <div class="checkout-grid">
        <div class="left-column">

          <!-- SZ√ÅML√ÅZ√ÅSI ADATOK -->
          <div class="form-section">
            <h3 class="section-title">üìã Sz√°ml√°z√°si adatok</h3>

            <div class="input-group">
              <label for="fullName">Teljes n√©v *</label>
              <input type="text" id="fullName" name="fullName" required placeholder="Teljes n√©v">
            </div>

            <div class="input-group">
              <label for="email">Email c√≠m *</label>
              <input type="email" id="email" name="email" required placeholder="email@example.com">
            </div>

            <div class="input-group">
              <label for="phone">Telefonsz√°m</label>
              <input type="text" id="phone" name="phone" placeholder="+36 30 123 4567">
            </div>

            <div class="flex">
              <div class="input-group">
                <label for="country">Orsz√°g *</label>
                <select id="country" name="country" required>
                  <option value="Magyarorsz√°g">Magyarorsz√°g</option>
                </select>
              </div>
              <div class="input-group">
                <label for="zip">Ir√°ny√≠t√≥sz√°m *</label>
                <input type="text" id="zip" name="zip" required placeholder="1234" pattern="[0-9]{4}">
              </div>
            </div>

            <div class="input-group">
              <label for="city">V√°ros *</label>
              <input type="text" id="city" name="city" required placeholder="Budapest">
            </div>

            <div class="input-group">
              <label for="address">Lakc√≠m *</label>
              <input type="text" id="address" name="address" required placeholder="Utca, h√°zsz√°m (√©p√ºlet, emelet, ajt√≥)">
            </div>
          </div>

          <!-- SZ√ÅLL√çT√ÅSI OPCI√ìK -->
          <div class="form-section">
            <h3 class="section-title">üöö Sz√°ll√≠t√°si m√≥d</h3>

            <div class="shipping-options">
              <div class="shipping-option" data-shipping="pickup" data-price="899">
                <div class="shipping-option-header">
                  <span class="shipping-option-title">üì¶ Foxpost csomagpont</span>
                  <span class="shipping-option-price">899 Ft</span>
                </div>
                <div class="shipping-option-desc">
                  √Åtv√©tel b√°rmelyik Foxpost automat√°n√°l vagy partnerponton.
                  K√©nyelmes √©s rugalmas √°tv√©tel h√©t k√∂zben √©s h√©tv√©g√©n is.
                </div>
              </div>

              <div class="shipping-option" data-shipping="home" data-price="2590">
                <div class="shipping-option-header">
                  <span class="shipping-option-title">üè† H√°zhozsz√°ll√≠t√°s</span>
                  <span class="shipping-option-price">2 590 Ft</span>
                </div>
                <div class="shipping-option-desc">
                  Kisz√°ll√≠t√°s a megadott c√≠mre munkanapokon 8‚Äì17 √≥ra k√∂z√∂tt.
                  A fut√°r telefonon egyeztet a pontos id≈ëpontr√≥l.
                </div>
              </div>
            </div>

            <!-- Csomagpont keres≈ë (pickup eset√©n) -->
            <div class="pickup-point-selector" id="pickup-selector">
              <div class="pickup-search">
                <input type="text" id="pickup-search" placeholder="Keress c√≠m vagy ir√°ny√≠t√≥sz√°m alapj√°n...">
                <button type="button" onclick="searchPickupPoints()">üîç</button>
              </div>
              <div class="pickup-points-list" id="pickup-points">
                <div style="padding: 2rem; text-align: center; color: rgba(255,255,255,0.6);">
                  Add meg a keres√©si felt√©telt a csomagpontok megjelen√≠t√©s√©hez
                </div>
              </div>
            </div>

            <!-- H√°zhozsz√°ll√≠t√°si c√≠m (home eset√©n) -->
            <div class="home-delivery-address" id="delivery-address">
              <div class="input-group">
                <label for="deliveryAddress">Sz√°ll√≠t√°si c√≠m</label>
                <input type="text" id="deliveryAddress" name="deliveryAddress"
                       placeholder="Ha elt√©r a sz√°ml√°z√°si c√≠mt≈ël">
              </div>
              <div class="flex">
                <div class="input-group">
                  <label for="deliveryCity">V√°ros</label>
                  <input type="text" id="deliveryCity" name="deliveryCity">
                </div>
                <div class="input-group">
                  <label for="deliveryZip">Ir√°ny√≠t√≥sz√°m</label>
                  <input type="text" id="deliveryZip" name="deliveryZip" pattern="[0-9]{4}">
                </div>
              </div>
              <div class="input-group">
                <label for="deliveryNote">Fut√°rnak sz√≥l√≥ √ºzenet</label>
                <input type="text" id="deliveryNote" name="deliveryNote"
                       placeholder="pl. csengesd meg 2x, nagy kutya van">
              </div>
            </div>
          </div>
        </div>

        <!-- JOBB OSZLOP: √ñSSZES√çT≈ê -->
        <div class="right-column">
          <div class="order-summary">
            <h3>Rendel√©s √∂sszes√≠t≈ë</h3>

            <div class="cart-items" id="cart-items-summary">
              <div style="padding:1rem; color:rgba(255,255,255,0.5);">Kos√°r bet√∂lt√©se...</div>
            </div>

            <div class="order-totals">
              <div class="order-line">
                <span>Term√©kek √∂sszesen:</span>
                <span id="subtotal">0 Ft</span>
              </div>
              <div class="order-line">
                <span>Sz√°ll√≠t√°si d√≠j:</span>
                <span id="shipping-cost">0 Ft</span>
              </div>
              <div class="order-line total">
                <span>V√©g√∂sszeg:</span>
                <span id="total-price">0 Ft</span>
              </div>
            </div>

            <!-- √ÅSZF + email consent -->
            <div class="terms-acceptance">
              <label class="terms-checkbox">
                <input type="checkbox" id="terms-agree" name="terms-agree">
                <span class="terms-text">
                  Elolvastam √©s elfogadom az
                  <a href="assets/√ÅSZF.pdf" target="_blank" class="terms-link">√Åltal√°nos Szerz≈ëd√©si Felt√©teleket</a>
                </span>
              </label>
              <label class="terms-checkbox">
                <input type="checkbox" id="email-consent" name="email-consent">
                <span class="terms-text">
                  Elfogadom, hogy a megrendel√©semhez kapcsol√≥d√≥
                  <a href="assets/adatvedelmi-t√°j√©koztat√≥.pdf" target="_blank" class="terms-link">adatkezel√©si t√°j√©koztat√≥ban</a>
                  szerepl≈ë m√≥don kezelj√°k a szem√©lyes adataimat.
                </span>
              </label>
            </div>

            <button type="submit" class="submit-btn">Megrendel√©s lead√°sa</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
  // ============================================================
  // STATE
  // ============================================================
  let cart = [];
  let selectedShipping = null;        // 'pickup' | 'home'
  let selectedPickupPoint = null;     // the full foxpost point object
  let foxpostPoints = [];             // all loaded foxpost points

  // ============================================================
  // INIT
  // ============================================================
  document.addEventListener('DOMContentLoaded', function () {
    loadCart();
    setupEventListeners();
    loadFoxpostPoints();
  });

  // ============================================================
  // CART
  // ============================================================
  function loadCart() {
    try {
      const raw = localStorage.getItem('cart');
      cart = raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error('Cart parse error:', e);
      cart = [];
    }

    if (cart.length === 0) {
      document.getElementById('cart-items-summary').innerHTML =
        '<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.6);">' +
        '<p>A kos√°r √ºres</p>' +
        '<a href="index.html" style="color:#fff;text-decoration:underline;">Vissza a f≈ëoldalra</a></div>';
      document.querySelector('.submit-btn').disabled = true;
      return;
    }

    renderCartSummary();
    calculateTotals();
  }

  function parsePrice(val) {
    return typeof val === 'string' ? parseInt(val.replace(/\D/g, ''), 10) : val;
  }

  function renderCartSummary() {
    const EBOOK_IDS      = [2, 4, 300];
    const PHYSICAL_BOOK  = 1;

    document.getElementById('cart-items-summary').innerHTML = cart.map(item => {
      const price    = parsePrice(item.price);
      const qty      = item.quantity || 1;
      const total    = price * qty;
      const qtyLabel = qty > 1 ? ` (${qty} db)` : '';

      // E-k√∂nyv
      if (EBOOK_IDS.includes(item.id)) {
        return `<div class="cart-item">
          <img src="${item.image}" alt="${item.name}">
          <div class="cart-item-details">
            <div class="cart-item-name">${item.name}${qtyLabel}</div>
            <div class="cart-item-price">${total.toLocaleString('hu-HU')} Ft</div>
            <span style="font-size:0.8rem;color:rgba(255,255,255,0.5);">Digit√°lis term√©k</span>
          </div></div>`;
      }

      // Fizikai k√∂nyv (A5 fix)
      if (item.id === PHYSICAL_BOOK) {
        return `<div class="cart-item">
          <img src="${item.image}" alt="${item.name}">
          <div class="cart-item-details">
            <div class="cart-item-name">${item.name}${qtyLabel}</div>
            <div class="cart-item-price">${total.toLocaleString('hu-HU')} Ft</div>
            <span style="font-size:0.85rem;color:rgba(255,255,255,0.7);font-weight:500;">üìè M√©ret: A5 (14.8 √ó 21 cm)</span>
          </div></div>`;
      }

      // Ruh√°zat ‚Äî size select ha nincs
      const sizeHtml = item.size
        ? `<span style="font-size:0.85rem;color:rgba(255,255,255,0.7);font-weight:500;">üìè M√©ret: ${item.size}</span>`
        : `<div class="size-selector">
            <select class="size-select" data-id="${item.id}" required>
              <option value="">V√°lassz m√©retet</option>
              <option value="S">S</option><option value="M">M</option>
              <option value="L">L</option><option value="XL">XL</option>
            </select></div>`;

      return `<div class="cart-item">
        <img src="${item.image}" alt="${item.name}">
        <div class="cart-item-details">
          <div class="cart-item-name">${item.name}${qtyLabel}</div>
          <div class="cart-item-price">${total.toLocaleString('hu-HU')} Ft</div>
          ${sizeHtml}
        </div></div>`;
    }).join('');
  }

  // ============================================================
  // EVENTS
  // ============================================================
  function setupEventListeners() {
    // Shipping option click
    document.querySelectorAll('.shipping-option').forEach(opt => {
      opt.addEventListener('click', function () { selectShippingOption(this); });
    });

    // Form submit
    document.getElementById('checkout-form').addEventListener('submit', handleFormSubmit);

    // Pickup search input debounce
    document.getElementById('pickup-search').addEventListener('input', debounce(searchPickupPoints, 500));

    // Copy billing ‚Üí delivery defaults
    ['zip','city'].forEach(id => {
      document.getElementById(id).addEventListener('change', function () {
        const delivId = id === 'zip' ? 'deliveryZip' : 'deliveryCity';
        if (!document.getElementById(delivId).value) {
          document.getElementById(delivId).value = this.value;
        }
      });
    });

    // Auto-search pickup on ZIP change if pickup selected
    document.getElementById('zip').addEventListener('change', function () {
      if (this.value.length === 4 && selectedShipping === 'pickup') {
        document.getElementById('pickup-search').value = this.value;
        searchPickupPoints();
      }
    });
  }

  function selectShippingOption(el) {
    document.querySelectorAll('.shipping-option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    selectedShipping = el.dataset.shipping;

    document.getElementById('pickup-selector').classList.toggle('active',   selectedShipping === 'pickup');
    document.getElementById('delivery-address').classList.toggle('active',  selectedShipping === 'home');

    calculateTotals();
  }

  // ============================================================
  // FOXPOST POINTS (read-only, no API write here!)
  // ============================================================
  async function loadFoxpostPoints() {
    try {
      const res  = await fetch('https://cdn.foxpost.hu/foxplus.json');
      const data = await res.json();
      foxpostPoints = data.filter(p => p.country === 'HU' && p.name && p.address);
      console.log(`Loaded ${foxpostPoints.length} Foxpost points`);
    } catch (e) {
      console.error('Foxpost points load error:', e);
      foxpostPoints = [];
    }
  }

  function searchPickupPoints() {
    const q = document.getElementById('pickup-search').value.trim();
    if (!q || q.length < 3) return;

    const filtered = foxpostPoints.filter(p => {
      const txt = `${p.name} ${p.address} ${p.city} ${p.zip}`.toLowerCase();
      return txt.includes(q.toLowerCase());
    }).slice(0, 20);

    renderPickupPoints(filtered);
  }

  function renderPickupPoints(points) {
    const container = document.getElementById('pickup-points');
    if (points.length === 0) {
      container.innerHTML = '<div style="padding:2rem;text-align:center;color:rgba(255,255,255,0.6);">Nem tal√°lhat√≥ csomagpont. Pr√≥b√°ld m√°s kulcssz√≥val.</div>';
      return;
    }

    container.innerHTML = points.map((p, i) => `
      <div class="pickup-point" data-idx="${i}" onclick="selectPickupPoint(${i})">
        <div class="pickup-point-name">${p.name}</div>
        <div class="pickup-point-address">${p.zip} ${p.city}, ${p.address}</div>
        <div class="pickup-point-info">${p.variant || ''} ${p.cardPayment ? '‚Ä¢ Bankk√°rtya' : ''} ${p.cashPayment ? '‚Ä¢ K√©szp√©nz' : ''}</div>
      </div>
    `).join('');

    // keep a filtered-list reference for selectPickupPoint
    window._currentFilteredPoints = points;
  }

  function selectPickupPoint(idx) {
    const point = window._currentFilteredPoints[idx];
    if (!point) return;

    // highlight
    document.querySelectorAll('.pickup-point').forEach(p => p.classList.remove('selected'));
    const clicked = document.querySelector(`.pickup-point[data-idx="${idx}"]`);
    if (clicked) clicked.classList.add('selected');

    selectedPickupPoint = point;

    // show selection info box
    const existing = document.querySelector('.selected-pickup-info');
    if (existing) existing.remove();

    const info = document.createElement('div');
    info.className = 'selected-pickup-info';
    info.style.cssText = 'margin-top:1rem;padding:1rem;background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.3);border-radius:8px;color:#4CAF50;font-size:0.9rem;';
    info.innerHTML = `<strong>Kiv√°lasztott csomagpont:</strong><br>${point.name}<br>${point.zip} ${point.city}, ${point.address}`;
    document.getElementById('pickup-selector').appendChild(info);
  }

  // ============================================================
  // TOTALS
  // ============================================================
  function calculateTotals() {
    const EBOOK_IDS = [2, 4, 300];

    const subtotal = cart.reduce((sum, item) => {
      return sum + parsePrice(item.price) * (item.quantity || 1);
    }, 0);

    let shippingCost = 0;
    const hasPhysical = cart.some(item => !EBOOK_IDS.includes(item.id));

    if (hasPhysical && selectedShipping) {
      shippingCost = selectedShipping === 'pickup' ? 899 : 2590;
    }

    document.getElementById('subtotal').textContent     = `${subtotal.toLocaleString('hu-HU')} Ft`;
    document.getElementById('shipping-cost').textContent = `${shippingCost.toLocaleString('hu-HU')} Ft`;
    document.getElementById('total-price').textContent   = `${(subtotal + shippingCost).toLocaleString('hu-HU')} Ft`;
  }

  // ============================================================
  // VALIDATION
  // ============================================================
  function validateForm() {
    // Required text fields
    const requiredIds = ['fullName', 'email', 'address', 'city', 'zip'];
    let valid = true;
    requiredIds.forEach(id => {
      const el = document.getElementById(id);
      if (!el.value.trim()) { el.style.borderColor = '#ff4444'; valid = false; }
      else                   { el.style.borderColor = 'rgba(255,255,255,0.2)'; }
    });
    if (!valid) { alert('K√©rj√ºk, t√∂ltsd ki az √∂sszes k√∂telez≈ë mez≈ët!'); return false; }

    // Email format
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(document.getElementById('email').value)) {
      document.getElementById('email').style.borderColor = '#ff4444';
      alert('K√©rj√ºk, adj meg √©rv√©nyes email c√≠met!');
      return false;
    }

    // ZIP format (4 digit)
    if (!/^[0-9]{4}$/.test(document.getElementById('zip').value)) {
      document.getElementById('zip').style.borderColor = '#ff4444';
      alert('K√©rj√ºk, adj meg √©rv√©nyes ir√°ny√≠t√≥sz√°mot (4 sz√°mjegy)!');
      return false;
    }

    // √ÅSZF
    if (!document.getElementById('terms-agree').checked) {
      alert('K√©rj√ºk, fogadd el az √Åltal√°nos Szerz≈ëd√©si Felt√©teleket a folytat√°shoz!');
      document.getElementById('terms-agree').focus();
      return false;
    }

    // Email consent
    if (!document.getElementById('email-consent').checked) {
      alert('K√©rj√ºk, fogadd el az adatkezel√©si t√°j√©koztat√≥t a folytat√°shoz!');
      document.getElementById('email-consent').focus();
      return false;
    }

    // Shipping must be selected
    if (!selectedShipping) {
      alert('K√©rj√ºk, v√°lassz sz√°ll√≠t√°si m√≥dot!');
      return false;
    }

    // Pickup ‚Üí csomagpont k√∂telez≈ë
    if (selectedShipping === 'pickup' && !selectedPickupPoint) {
      alert('K√©rj√ºk, v√°lassz csomagpontot!');
      document.getElementById('pickup-selector').scrollIntoView({ behavior: 'smooth', block: 'center' });
      return false;
    }

    // Size for clothing (not book ID=1, not ebook IDs)
    const EBOOK_IDS     = [2, 4, 300];
    const PHYSICAL_BOOK = 1;
    const needsSize = cart.some(item => !EBOOK_IDS.includes(item.id) && item.id !== PHYSICAL_BOOK && !item.size);

    if (needsSize) {
      let allPicked = true;
      document.querySelectorAll('.size-select').forEach(sel => {
        if (!sel.value) { sel.style.borderColor = '#ff4444'; allPicked = false; }
        else            { sel.style.borderColor = 'rgba(255,255,255,0.2)'; }
      });
      if (!allPicked) { alert('K√©rj√ºk, v√°lassz m√©retet minden ruh√°zati term√©khez!'); return false; }
    }

    return true;
  }

  // ============================================================
  // COLLECT + SUBMIT
  // ============================================================
  async function handleFormSubmit(e) {
    e.preventDefault();
    if (!validateForm()) return;

    const btn = document.querySelector('.submit-btn');
    btn.disabled = true;
    btn.textContent = 'Feldolgoz√°s...';

    try {
      const payload = collectOrderData();
      await submitOrder(payload);
    } catch (err) {
      console.error('Order error:', err);
      alert('Hiba t√∂rt√©nt a megrendel√©s feldolgoz√°sa sor√°n. K√©rj√ºk, pr√≥b√°ld √∫jra!');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Megrendel√©s lead√°sa';
    }
  }

  function collectOrderData() {
    const form     = document.getElementById('checkout-form');
    const fd       = new FormData(form);
    const EBOOK_IDS     = [2, 4, 300];
    const PHYSICAL_BOOK = 1;

    // --- size map ---
    const sizeMap = {};
    cart.forEach(item => {
      if (item.id === PHYSICAL_BOOK) sizeMap[item.id] = 'A5';
      if (item.size)                 sizeMap[item.id] = item.size;
    });
    document.querySelectorAll('.size-select').forEach(sel => {
      if (sel.value) sizeMap[sel.dataset.id] = sel.value;
    });

    // --- customerData: EVERY field the server reads from metadata ---
    const customerData = {
      fullName:          fd.get('fullName')          || '',
      email:             fd.get('email')             || '',
      phone:             fd.get('phone')             || '',
      address:           fd.get('address')           || '',
      city:              fd.get('city')              || '',
      country:           fd.get('country')           || '',
      zip:               fd.get('zip')               || '',
      shippingMethod:    selectedShipping,            // 'pickup' | 'home'
      deliveryNote:      fd.get('deliveryNote')      || '',
      // pickup fields ‚Äî filled only when pickup, else empty string
      pickupPointName:   '',
      pickupPoint:       null,
      // home delivery fields ‚Äî filled only when home, else empty string
      deliveryAddress:   '',
      deliveryCity:      fd.get('deliveryCity')      || '',
      deliveryZip:       fd.get('deliveryZip')       || '',
      deliveryCountry:   fd.get('country')           || ''
    };

    if (selectedShipping === 'pickup' && selectedPickupPoint) {
      // Server needs: pickupPointName (string) + pickupPoint (object with operator_id/place_id)
      customerData.pickupPointName = selectedPickupPoint.name || '';
      customerData.pickupPoint     = selectedPickupPoint;
      // deliveryAddress = the pickup point address (for the sheet "Sz√°ll√≠t√°si c√≠m")
      customerData.deliveryAddress = `${selectedPickupPoint.zip || ''} ${selectedPickupPoint.city || ''}, ${selectedPickupPoint.address || ''}`;
    } else if (selectedShipping === 'home') {
      // If delivery address fields are empty, fall back to billing address
      customerData.deliveryAddress = fd.get('deliveryAddress') || fd.get('address')  || '';
      customerData.deliveryCity    = fd.get('deliveryCity')    || fd.get('city')     || '';
      customerData.deliveryZip     = fd.get('deliveryZip')     || fd.get('zip')      || '';
    }

    // --- cart items with size ---
    const cartForPayment = cart.map(item => {
      const obj = {
        id:       item.id,
        name:     item.name,
        price:    parsePrice(item.price),
        quantity: item.quantity || 1
      };
      // attach size for non-ebook items
      if (!EBOOK_IDS.includes(item.id) && sizeMap[item.id]) {
        obj.size = sizeMap[item.id];
      }
      return obj;
    });

    return { cart: cartForPayment, customerData: customerData };
  }

  async function submitOrder(payload) {
    const res = await fetch('/create-payment-session', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(payload)
    });

    const data = await res.json();

    if (res.ok && data.payment_url) {
      localStorage.removeItem('cart');
      window.location.href = data.payment_url;
    } else {
      throw new Error(data.error || 'Payment session creation failed');
    }
  }

  // ============================================================
  // UTIL
  // ============================================================
  function debounce(fn, wait) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }
  </script>
</body>
</html>